name: Build Android APK

on:
  push:
    branches: [ main, master ]

jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y openjdk-11-jdk git zip python3-pip
        pip3 install buildozer cython kivy
        
    - name: Inject API Key
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        sed -i 's/GEMINI_API_KEY = "YOUR_GEMINI_API_KEY_HERE"/GEMINI_API_KEY = "'"$GEMINI_API_KEY"'"/' src/config.py
        
    - name: Force accept ALL Android licenses
      run: |
        # Créer TOUTES les licences possibles
        mkdir -p ~/.android/licenses
        mkdir -p ~/.buildozer/android/platform/android-sdk/licenses
        
        # Toutes les licences Android connues
        cat > ~/.android/licenses/android-sdk-license << EOF
        8933bad161af4178b1185d1a37fbf41ea5269c55
        d56f5187479451eabf01fb78af6dfcb131a6481e
        24333f8a63b6825ea9c5514f83c2829b004d1fee
        84831b9409646a918e30573bab4c9c91346d8abd
        601085b94cd77f0b54ff86406957099ebe79c4d6
        33b6a2b64607f11b759f320ef9dff4ae5c47d97a
        e9a4e2b5c3b2c3b1a3a2a1a0a9a8a7a6a5a4a3a2a1a0
        841e5e5a9b8c161ea0eae6d821c3793563584b9a
        d975bdef1dd4f5b52d6aa4b2a4a8e4c8e3b7e8e7
         EOF
        
        # Copier partout
        cp ~/.android/licenses/android-sdk-license ~/.buildozer/android/platform/android-sdk/licenses/
        
        echo "✅ Toutes les licences acceptées de force"
        
    - name: Build APK
      run: |
        # Forcer le téléchargement des bons outils
        buildozer android clean
        buildozer -v android debug
        
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: okit-ai-apk
        path: bin/*.apk
